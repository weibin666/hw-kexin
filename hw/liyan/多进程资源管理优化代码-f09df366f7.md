### å¤šè¿›ç¨‹èµ„æºç®¡ç†ä¼˜åŒ–æ–¹æ¡ˆ

é’ˆå¯¹`TargetClosedError`å’Œ`CancelledError`ç­‰èµ„æºç®¡ç†ç›¸å…³é”™è¯¯ï¼Œä»¥ä¸‹æ˜¯ä¼˜åŒ–åçš„ä»£ç å®ç°ï¼Œé‡ç‚¹è§£å†³æµè§ˆå™¨èµ„æºé‡Šæ”¾å’Œå¼‚æ­¥ä»»åŠ¡å–æ¶ˆé—®é¢˜ã€‚

#### ä¼˜åŒ–åçš„æ ¸å¿ƒä»£ç 
```python
import json
import pandas as pd
import requests
import time
import random
import signal
from multiprocessing import Process, Manager, cpu_count, Lock
from playwright.sync_api import sync_playwright, TimeoutError as PlaywrightTimeoutError, PlaywrightError
from queue import Empty

# å…¨å±€é…ç½®
REQUESTS_PER_PROXY = 20
SLIDER_DISTANCES = [250, 280]
PROXY_RETRY_LIMIT = 5
PAGE_LOAD_TIMEOUT = 30000
MAX_WORKER_RETRIES = 3

def safe_playwright_context():
    """å®‰å…¨çš„Playwrightä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾"""
    class SafePlaywright:
        def __init__(self):
            self.playwright = None
            self.browser = None
            self.context = None
            self.page = None
            self.running = False
            
        def __enter__(self):
            self.running = True
            self.playwright = sync_playwright().start()
            return self
            
        def __exit__(self, exc_type, exc_val, exc_tb):
            self.running = False
            # æŒ‰é€†åºé‡Šæ”¾èµ„æº
            if self.page:
                try:
                    self.page.close()
                except PlaywrightError:
                    pass
            if self.context:
                try:
                    self.context.close()
                except PlaywrightError:
                    pass
            if self.browser:
                try:
                    self.browser.close()
                except PlaywrightError:
                    pass
            if self.playwright:
                try:
                    self.playwright.stop()
                except PlaywrightError:
                    pass
            return False  # ä¸æŠ‘åˆ¶å¼‚å¸¸
            
        def create_browser(self, proxy=None):
            """åˆ›å»ºæµè§ˆå™¨å®ä¾‹ï¼Œå¸¦é”™è¯¯å¤„ç†"""
            try:
                browser_args = [
                    '--disable-gpu', 
                    '--disable-dev-shm-usage', 
                    '--no-sandbox',
                    '--ignore-certificate-errors',
                    '--disable-blink-features=AutomationControlled'
                ]
                
                self.browser = self.playwright.chromium.launch(
                    headless=False,
                    args=browser_args
                )
                
                context_args = {
                    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
                    "ignore_https_errors": True
                }
                
                if proxy:
                    context_args["proxy"] = {
                        "server": proxy["server"],
                        "username": proxy["username"],
                        "password": proxy["password"]
                    }
                    
                self.context = self.browser.new_context(**context_args)
                self.page = self.context.new_page()
                return self.page
                
            except Exception as e:
                print(f"åˆ›å»ºæµè§ˆå™¨ä¸Šä¸‹æ–‡å¤±è´¥: {str(e)}")
                # ç¡®ä¿å¤±è´¥æ—¶èµ„æºè¢«é‡Šæ”¾
                self.__exit__(None, None, None)
                raise

def handle_request(route, request, page_context):
    """ç‹¬ç«‹çš„è¯·æ±‚å¤„ç†å‡½æ•°ï¼Œå¢åŠ é¡µé¢ä¸Šä¸‹æ–‡æ£€æŸ¥"""
    # æ£€æŸ¥é¡µé¢æ˜¯å¦å·²å…³é—­
    if not page_context.running:
        return
        
    try:
        if "need_register" in request.url:
            print(f"æ‰¾åˆ°ç›®æ ‡è¯·æ±‚: {request.url}")
            post_data = request.post_data
            if post_data:
                intercepted_data = {
                    'url': request.url,
                    'headers': dict(request.headers),
                    'post_data': post_data
                }
                with page_context.results_lock:
                    page_context.results.append(intercepted_data)
                route.abort()
                return
        route.continue_()
    except PlaywrightError as e:
        print(f"è·¯ç”±å¤„ç†é”™è¯¯: {str(e)}")
    except Exception as e:
        print(f"è¯·æ±‚å¤„ç†å¼‚å¸¸: {str(e)}")

def browser_consumer(worker_id, phone_queue, results, results_lock):
    """ä¼˜åŒ–åçš„æµè§ˆå™¨æ¶ˆè´¹è€…ï¼Œå¢å¼ºèµ„æºç®¡ç†å’Œé”™è¯¯å¤„ç†"""
    print(f"ğŸ› ï¸ Worker {worker_id} started")
    request_count = 0
    current_proxy = None
    proxy_retries = 0
    worker_retries = 0
    page_context = None
    
    # è®¾ç½®è¿›ç¨‹é€€å‡ºä¿¡å·å¤„ç†
    def signal_handler(signum, frame):
        print(f"Worker {worker_id} æ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨æ¸…ç†èµ„æº...")
        nonlocal page_context
        if page_context:
            page_context.running = False
        exit(0)
        
    signal.signal(signal.SIGTERM, signal_handler)
    signal.signal(signal.SIGINT, signal_handler)
    
    try:
        while worker_retries < MAX_WORKER_RETRIES:
            try:
                # åˆ›å»ºé¡µé¢ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œä¿å­˜å…±äº«çŠ¶æ€
                class PageContext:
                    def __init__(self):
                        self.results = results
                        self.results_lock = results_lock
                        self.running = True
                        self.route_set = False
                        
                page_context = PageContext()
                
                with safe_playwright_context() as pw:
                    while True:
                        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ¢ä»£ç†
                        if (request_count % REQUESTS_PER_PROXY == 0) or not current_proxy:
                            # è·å–æ–°ä»£ç†
                            try:
                                current_proxy = get_proxy()  # ä½¿ç”¨ä¹‹å‰å®šä¹‰çš„get_proxyå‡½æ•°
                                print(f"Worker {worker_id} è·å–æ–°ä»£ç†: {current_proxy['server'].split('//')[-1]}")
                                request_count = 0
                                proxy_retries = 0
                            except Exception as e:
                                print(f"è·å–ä»£ç†å¤±è´¥: {str(e)}")
                                proxy_retries += 1
                                if proxy_retries >= PROXY_RETRY_LIMIT:
                                    raise Exception("è¾¾åˆ°æœ€å¤§ä»£ç†é‡è¯•æ¬¡æ•°")
                                time.sleep(PROXY_RETRY_LIMIT * (proxy_retries + 1))
                                continue
                            
                            # åˆ›å»ºæ–°æµè§ˆå™¨å®ä¾‹
                            try:
                                page = pw.create_browser(current_proxy)
                                # ç¡®ä¿ç§»é™¤ä¹‹å‰çš„è·¯ç”±ç›‘å¬
                                if page_context.route_set:
                                    page.unroute("**/*")
                                # è®¾ç½®æ–°çš„è·¯ç”±ç›‘å¬ï¼Œä¼ å…¥é¡µé¢ä¸Šä¸‹æ–‡
                                page.route("**/*", lambda route, request: handle_request(route, request, page_context))
                                page_context.route_set = True
                            except Exception as e:
                                print(f"åˆ›å»ºæµè§ˆå™¨å¤±è´¥: {str(e)}")
                                proxy_retries += 1
                                if proxy_retries >= PROXY_RETRY_LIMIT:
                                    raise Exception("è¾¾åˆ°æœ€å¤§æµè§ˆå™¨åˆ›å»ºé‡è¯•æ¬¡æ•°")
                                time.sleep(PROXY_RETRY_LIMIT * (proxy_retries + 1))
                                continue
                        
                        # å¤„ç†ä»»åŠ¡é˜Ÿåˆ—
                        try:
                            phone = phone_queue.get_nowait()
                            print(f"ğŸ”§ Worker {worker_id} processing: {phone} (è¯·æ±‚æ¬¡æ•°: {request_count+1}/{REQUESTS_PER_PROXY})")
                            
                            # æ‰§è¡Œæµ‹è¯•
                            result = test_interception_for_phone(page, worker_id, phone)
                            if result:
                                with results_lock:
                                    results.append(result)
                                print(f"ğŸ“¥ Worker {worker_id} added result to queue")
                            
                            phone_queue.task_done()
                            request_count += 1
                            proxy_retries = 0
                            
                        except Empty:
                            # é˜Ÿåˆ—ä¸ºç©ºï¼Œé€€å‡ºå¤„ç†å¾ªç¯
                            print(f"Worker {worker_id} ä»»åŠ¡é˜Ÿåˆ—å·²ç©º")
                            return
                        except PlaywrightError as e:
                            print(f"é¡µé¢æ“ä½œé”™è¯¯: {str(e)}")
                            # é¡µé¢å¯èƒ½å·²å…³é—­ï¼Œéœ€è¦é‡æ–°åˆ›å»º
                            request_count = REQUESTS_PER_PROXY  # è§¦å‘ä»£ç†æ›´æ¢
                            phone_queue.put(phone)  # å°†ä»»åŠ¡æ”¾å›é˜Ÿåˆ—
                            time.sleep(2)
                        except Exception as e:
                            print(f"å¤„ç†ä»»åŠ¡å¼‚å¸¸: {str(e)}")
                            phone_queue.task_done()
                            worker_retries += 1
                            if worker_retries >= MAX_WORKER_RETRIES:
                                raise
                            time.sleep(2)
                            
            except Exception as e:
                print(f"Worker {worker_id} ä¸»å¾ªç¯å¼‚å¸¸: {str(e)}")
                worker_retries += 1
                if worker_retries >= MAX_WORKER_RETRIES:
                    print(f"Worker {worker_id} è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé€€å‡º")
                    return
                time.sleep(5)  # é‡è¯•å‰ç­‰å¾…
                
    finally:
        print(f"ğŸ Worker {worker_id} finished")
        # ç¡®ä¿èµ„æºè¢«é‡Šæ”¾
        if page_context:
            page_context.running = False

def test_interception_for_phone(page, worker_id, test_phone):
    """ä¼˜åŒ–çš„æµ‹è¯•å‡½æ•°ï¼Œå¢åŠ é¡µé¢çŠ¶æ€æ£€æŸ¥"""
    print(f"\nWorker {worker_id} æµ‹è¯•æ‰‹æœºå·: {test_phone}")
    intercepted_data = None
    
    try:
        # æ£€æŸ¥é¡µé¢æ˜¯å¦å¯ç”¨
        if not page or page.is_closed():
            raise Exception("é¡µé¢å·²å…³é—­")
            
        page.goto(
            "https://login.dingtalk.com/oauth2/challenge.htm?redirect_uri=https%3A%2F%2Foa.dingtalk.com%2Fomp%2Flogin%2Fdingtalk_sso_call_back%3Fcontinue%3Dhttps%253A%252F%252Foa.dingtalk.com%252Findex.htm&response_type=code&client_id=dingoaltcsv4vlgoefhpec&scope=openid+corpid&org_type=management#/login",
            wait_until="domcontentloaded",
            timeout=PAGE_LOAD_TIMEOUT
        )
        
        # [ä¿æŒåŸæœ‰è¾“å…¥æ‰‹æœºå·å’Œç‚¹å‡»æŒ‰é’®é€»è¾‘ä¸å˜]
        
        # ç­‰å¾…è¯·æ±‚è¢«æ‹¦æˆª
        start_time = time.time()
        while time.time() - start_time < 10:  # æœ€å¤šç­‰å¾…10ç§’
            # æ£€æŸ¥æ˜¯å¦æœ‰æ‹¦æˆªåˆ°çš„æ•°æ®
            with page_context.results_lock:
                if page_context.results:
                    intercepted_data = page_context.results.pop(0)
                    break
            time.sleep(0.5)
            
        return intercepted_data if intercepted_data else None
        
    except PlaywrightTimeoutError:
        print(f"Worker {worker_id} é¡µé¢åŠ è½½è¶…æ—¶")
        return None
    except PlaywrightError as e:
        print(f"Worker {worker_id} Playwrighté”™è¯¯: {str(e)}")
        # é¡µé¢å¯èƒ½å·²å…³é—­ï¼ŒæŠ›å‡ºå¼‚å¸¸è®©ä¸Šå±‚å¤„ç†
        raise
    except Exception as e:
        print(f"Worker {worker_id} æµ‹è¯•å¼‚å¸¸: {str(e)}")
        return None
```

#### ä¸»è¦ä¼˜åŒ–ç‚¹è¯´æ˜

1. **å®‰å…¨çš„èµ„æºç®¡ç†ä¸Šä¸‹æ–‡**
   - åˆ›å»º`SafePlaywright`ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®é‡Šæ”¾æµè§ˆå™¨èµ„æº
   - å®ç°èµ„æºé€†åºé‡Šæ”¾æœºåˆ¶ï¼ˆé¡µé¢â†’ä¸Šä¸‹æ–‡â†’æµè§ˆå™¨â†’Playwrightå®ä¾‹ï¼‰
   - æ·»åŠ `running`æ ‡å¿—è·Ÿè¸ªä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œé¿å…æ“ä½œå·²å…³é—­çš„èµ„æº

2. **å¢å¼ºçš„å¼‚å¸¸å¤„ç†**
   - ä¸“é—¨æ•è·`PlaywrightError`å¤„ç†Playwrightç›¸å…³å¼‚å¸¸
   - åœ¨è·¯ç”±å¤„ç†å‡½æ•°ä¸­æ·»åŠ é¡µé¢çŠ¶æ€æ£€æŸ¥ï¼Œé¿å…æ“ä½œå·²å…³é—­é¡µé¢
   - å®ç°å·¥ä½œè¿›ç¨‹é‡è¯•æœºåˆ¶ï¼Œå…è®¸æœ‰é™æ¬¡æ•°çš„æ¢å¤

3. **æ”¹è¿›çš„è·¯ç”±ç®¡ç†**
   - å°†è¯·æ±‚å¤„ç†é€»è¾‘åˆ†ç¦»ä¸ºç‹¬ç«‹çš„`handle_request`å‡½æ•°
   - è·¯ç”±å¤„ç†å‰æ£€æŸ¥é¡µé¢ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œé¿å…åœ¨é¡µé¢å…³é—­åæ‰§è¡Œæ“ä½œ
   - æ·»åŠ è·¯ç”±ç›‘å¬çš„åˆ›å»ºå’Œç§»é™¤é€»è¾‘ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

4. **è¿›ç¨‹ä¿¡å·å¤„ç†**
   - æ·»åŠ SIGTERMå’ŒSIGINTä¿¡å·å¤„ç†ï¼Œç¡®ä¿è¿›ç¨‹é€€å‡ºæ—¶èµ„æºæ­£ç¡®æ¸…ç†
   - å®ç°ä¼˜é›…å…³é—­æœºåˆ¶ï¼Œé¿å…å¼ºåˆ¶é€€å‡ºå¯¼è‡´çš„èµ„æºæ³„æ¼

5. **çŠ¶æ€è·Ÿè¸ªä¸æ¢å¤**
   - åˆ›å»º`PageContext`ç±»ç»Ÿä¸€ç®¡ç†é¡µé¢ç›¸å…³çŠ¶æ€
   - è·Ÿè¸ªè¯·æ±‚è®¡æ•°ã€ä»£ç†çŠ¶æ€å’Œé‡è¯•æ¬¡æ•°
   - å¤±è´¥æ—¶å°†ä»»åŠ¡æ”¾å›é˜Ÿåˆ—ï¼Œç¡®ä¿ä»»åŠ¡ä¸ä¸¢å¤±

#### é”™è¯¯å¤„ç†æµç¨‹ä¼˜åŒ–
1. **TargetClosedErroré¢„é˜²**
   - åœ¨æ‰€æœ‰é¡µé¢æ“ä½œå‰æ£€æŸ¥é¡µé¢çŠ¶æ€
   - ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
   - é¡µé¢å…³é—­å‰å–æ¶ˆè·¯ç”±ç›‘å¬

2. **CancelledErrorå¤„ç†**
   - è·¯ç”±å¤„ç†æ·»åŠ çŠ¶æ€æ£€æŸ¥
   - å¼‚æ­¥ä»»åŠ¡å–æ¶ˆæ—¶å®‰å…¨é€€å‡º
   - é¿å…åœ¨èµ„æºé‡Šæ”¾åæ‰§è¡Œå›è°ƒ

3. **å¤šè¿›ç¨‹ç¨³å®šæ€§æå‡**
   - é™åˆ¶å·¥ä½œè¿›ç¨‹æœ€å¤§é‡è¯•æ¬¡æ•°
   - å¼‚å¸¸æ—¶é‡ç½®æµè§ˆå™¨ä¸Šä¸‹æ–‡
   - ä»»åŠ¡å¤„ç†å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•

#### ä½¿ç”¨å»ºè®®
1. ç¡®ä¿Playwrightç‰ˆæœ¬æ›´æ–°åˆ°æœ€æ–°ï¼ˆ>=1.30.0ï¼‰ï¼Œä¿®å¤å·²çŸ¥çš„èµ„æºç®¡ç†é—®é¢˜
2. ç›‘æ§`MAX_WORKER_RETRIES`å‚æ•°ï¼Œå¦‚æœé¢‘ç¹è¾¾åˆ°é‡è¯•ä¸Šé™ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ä»£ç†æœåŠ¡æˆ–å¢åŠ å»¶è¿Ÿ
3. å¦‚ä»é‡åˆ°èµ„æºé‡Šæ”¾é—®é¢˜ï¼Œå¯ä»¥å°è¯•å‡å°‘å¹¶å‘å·¥ä½œè¿›ç¨‹æ•°é‡
4. å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè¿½è¸ªèµ„æºä½¿ç”¨æƒ…å†µ

è¿™äº›ä¼˜åŒ–åº”è¯¥èƒ½å¤Ÿè§£å†³å¤§éƒ¨åˆ†èµ„æºç®¡ç†ç›¸å…³çš„é”™è¯¯ï¼ŒåŒ…æ‹¬`TargetClosedError`å’Œ`CancelledError`ã€‚å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›æ›´è¯¦ç»†çš„é”™è¯¯å‘ç”Ÿæ—¶æœºå’Œåœºæ™¯ã€‚